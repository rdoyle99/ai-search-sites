---
import Base from '../../layouts/Base.astro';
import { siteConfig } from '../../config';

const schema = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Subject Line A/B Tester",
  "applicationCategory": "BusinessApplication",
  "description": "Compare two subject lines against our open rate prediction model trained on 5M+ cold emails.",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
};
---

<Base
  title="Subject Line A/B Tester | Cold Email Open Rate"
  description="Free tool: compare two cold email subject lines and predict which will get a higher open rate based on data from 5M+ cold emails."
  schema={schema}
>
  <section class="max-w-3xl mx-auto px-4 sm:px-6 py-12 md:py-20">
    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Subject Line A/B Tester</h1>
    <p class="mt-4 text-lg text-gray-600">
      Enter two subject lines and we'll predict which one will achieve a higher open rate based on patterns from 5M+ cold emails.
    </p>

    <div class="mt-10 space-y-6">
      <div class="p-6 border border-gray-200 rounded-lg bg-white">
        <label for="subject-a" class="block text-sm font-medium text-gray-700">Subject Line A</label>
        <input
          type="text"
          id="subject-a"
          placeholder="e.g., Quick question about {{company}}"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
        />
        <div id="score-a" class="mt-3 hidden">
          <div class="flex items-center gap-3">
            <span id="score-a-value" class="text-2xl font-bold text-gray-900"></span>
            <span id="score-a-label" class="text-sm text-gray-500"></span>
          </div>
          <div class="mt-2 w-full bg-gray-200 rounded-full h-3">
            <div id="bar-a" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="text-center text-gray-400 font-bold text-lg">VS</div>

      <div class="p-6 border border-gray-200 rounded-lg bg-white">
        <label for="subject-b" class="block text-sm font-medium text-gray-700">Subject Line B</label>
        <input
          type="text"
          id="subject-b"
          placeholder="e.g., {{firstName}}, saw your recent post"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
        />
        <div id="score-b" class="mt-3 hidden">
          <div class="flex items-center gap-3">
            <span id="score-b-value" class="text-2xl font-bold text-gray-900"></span>
            <span id="score-b-label" class="text-sm text-gray-500"></span>
          </div>
          <div class="mt-2 w-full bg-gray-200 rounded-full h-3">
            <div id="bar-b" class="bg-green-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <button
        id="compare-btn"
        class="w-full px-6 py-3 bg-gray-900 text-white font-semibold rounded-lg hover:bg-gray-800 transition-colors"
      >
        Compare Subject Lines
      </button>

      <div id="winner" class="hidden p-6 rounded-lg border-2">
        <div class="flex items-center gap-2">
          <span id="winner-badge" class="text-lg font-bold"></span>
        </div>
        <p id="winner-explanation" class="mt-2 text-sm text-gray-600"></p>
        <div id="factors" class="mt-4 space-y-2"></div>
      </div>
    </div>

    <div class="mt-8 p-6 border border-blue-200 rounded-lg bg-blue-50">
      <p class="text-sm font-medium text-blue-900">Want AI-optimized subject lines?</p>
      <p class="mt-1 text-sm text-blue-700">
        <a href={siteConfig.product.url} target="_blank" rel="noopener noreferrer" class="font-semibold underline">{siteConfig.product.name}</a> generates and A/B tests subject lines automatically, using AI trained on millions of cold emails.
      </p>
      <a href={siteConfig.product.url} target="_blank" rel="noopener noreferrer" class="mt-3 inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700 transition-colors">
        Optimize with {siteConfig.product.name} &rarr;
      </a>
    </div>

    <div class="mt-12 prose max-w-none">
      <h2>How the A/B Tester Works</h2>
      <p>
        This tool scores subject lines on factors proven to impact cold email open rates: <strong>length</strong> (3â€“6 words optimal), <strong>personalization</strong> (merge tags boost opens by 26%), <strong>spam triggers</strong> (promotional words reduce inbox placement), <strong>question format</strong> (questions get 14% higher opens), and <strong>capitalization</strong> (sentence case outperforms title case).
      </p>
      <p>
        The predicted open rate is based on aggregate patterns from cold email campaigns. Your actual results will vary based on list quality, sender reputation, and sending time. Use this tool to compare relative performance â€” the subject line with the higher score is more likely to outperform.
      </p>
    </div>
  </section>
</Base>

<script>
  const spamTriggers = ['free', 'guarantee', 'act now', 'limited', 'urgent', 'hurry', 'click', 'buy', 'discount', 'offer', 'deal', 'save', 'winner', 'congratulations', 'exclusive', 'amazing', 'incredible', '!!!', '???'];

  function scoreSubjectLine(subject: string): { score: number; factors: { label: string; impact: string; positive: boolean }[] } {
    if (!subject.trim()) return { score: 0, factors: [] };

    let score = 42; // baseline open rate
    const factors: { label: string; impact: string; positive: boolean }[] = [];
    const words = subject.trim().split(/\s+/).length;
    const chars = subject.length;
    const lower = subject.toLowerCase();

    // Length scoring
    if (words >= 3 && words <= 6) {
      score += 5;
      factors.push({ label: 'Optimal word count (3â€“6 words)', impact: '+5%', positive: true });
    } else if (words < 3) {
      score -= 2;
      factors.push({ label: 'Too short (under 3 words)', impact: '-2%', positive: false });
    } else if (words > 8) {
      score -= 6;
      factors.push({ label: 'Too long (over 8 words)', impact: '-6%', positive: false });
    } else {
      score -= 3;
      factors.push({ label: 'Slightly long (7â€“8 words)', impact: '-3%', positive: false });
    }

    // Character length
    if (chars <= 50) {
      score += 3;
      factors.push({ label: 'Good character length (â‰¤50)', impact: '+3%', positive: true });
    } else if (chars > 70) {
      score -= 4;
      factors.push({ label: 'Will get truncated on mobile (>70 chars)', impact: '-4%', positive: false });
    }

    // Personalization
    if (subject.includes('{{') || subject.includes('{')) {
      score += 8;
      factors.push({ label: 'Contains personalization tokens', impact: '+8%', positive: true });
    } else {
      factors.push({ label: 'No personalization tokens detected', impact: '0%', positive: false });
    }

    // Question format
    if (subject.includes('?')) {
      score += 4;
      factors.push({ label: 'Question format (drives curiosity)', impact: '+4%', positive: true });
    }

    // Spam triggers
    const foundSpam = spamTriggers.filter(t => lower.includes(t.toLowerCase()));
    if (foundSpam.length > 0) {
      const penalty = foundSpam.length * 4;
      score -= penalty;
      factors.push({ label: `Spam trigger words: ${foundSpam.join(', ')}`, impact: `-${penalty}%`, positive: false });
    }

    // ALL CAPS check
    if (subject.length > 3 && subject === subject.toUpperCase() && /[A-Z]/.test(subject)) {
      score -= 8;
      factors.push({ label: 'ALL CAPS (triggers spam filters)', impact: '-8%', positive: false });
    }

    // Starts with "Re:" or "Fwd:" (manipulative)
    if (lower.startsWith('re:') || lower.startsWith('fwd:')) {
      score -= 5;
      factors.push({ label: 'Fake Re:/Fwd: prefix (damages trust)', impact: '-5%', positive: false });
    }

    // Number in subject (specificity)
    if (/\d/.test(subject)) {
      score += 3;
      factors.push({ label: 'Contains numbers (adds specificity)', impact: '+3%', positive: true });
    }

    // Lowercase start (casual, human tone)
    if (subject[0] && subject[0] === subject[0].toLowerCase() && /[a-z]/.test(subject[0])) {
      score += 2;
      factors.push({ label: 'Lowercase start (conversational tone)', impact: '+2%', positive: true });
    }

    score = Math.max(5, Math.min(85, score));
    return { score, factors };
  }

  document.getElementById('compare-btn')?.addEventListener('click', () => {
    const subjectA = (document.getElementById('subject-a') as HTMLInputElement).value;
    const subjectB = (document.getElementById('subject-b') as HTMLInputElement).value;

    if (!subjectA.trim() && !subjectB.trim()) return;

    const resultA = scoreSubjectLine(subjectA);
    const resultB = scoreSubjectLine(subjectB);

    // Show score A
    if (subjectA.trim()) {
      document.getElementById('score-a')!.classList.remove('hidden');
      document.getElementById('score-a-value')!.textContent = `${resultA.score}%`;
      document.getElementById('score-a-label')!.textContent = 'predicted open rate';
      (document.getElementById('bar-a') as HTMLElement).style.width = `${resultA.score}%`;
    }

    // Show score B
    if (subjectB.trim()) {
      document.getElementById('score-b')!.classList.remove('hidden');
      document.getElementById('score-b-value')!.textContent = `${resultB.score}%`;
      document.getElementById('score-b-label')!.textContent = 'predicted open rate';
      (document.getElementById('bar-b') as HTMLElement).style.width = `${resultB.score}%`;
    }

    // Show winner
    const winnerEl = document.getElementById('winner')!;
    winnerEl.classList.remove('hidden');

    if (subjectA.trim() && subjectB.trim()) {
      const diff = Math.abs(resultA.score - resultB.score);
      const winner = resultA.score >= resultB.score ? 'A' : 'B';
      const winnerResult = winner === 'A' ? resultA : resultB;
      const color = winner === 'A' ? 'border-blue-300 bg-blue-50' : 'border-green-300 bg-green-50';

      winnerEl.className = `p-6 rounded-lg border-2 ${color}`;
      document.getElementById('winner-badge')!.textContent = diff < 3 ? 'ðŸ¤ Too close to call' : `ðŸ† Subject Line ${winner} wins by ${diff} points`;
      document.getElementById('winner-explanation')!.textContent = diff < 3
        ? 'Both subject lines scored within 3 points â€” the difference is negligible. Test both in a real A/B split.'
        : `Subject Line ${winner} is predicted to get ${diff}% more opens. Here's why:`;

      document.getElementById('factors')!.innerHTML = winnerResult.factors.map(f =>
        `<div class="flex items-center gap-2 text-sm">
          <span class="${f.positive ? 'text-green-600' : 'text-red-500'}">${f.positive ? 'âœ“' : 'âœ—'}</span>
          <span class="text-gray-700">${f.label}</span>
          <span class="ml-auto font-mono text-xs ${f.positive ? 'text-green-600' : 'text-red-500'}">${f.impact}</span>
        </div>`
      ).join('');
    } else {
      const result = subjectA.trim() ? resultA : resultB;
      const label = subjectA.trim() ? 'A' : 'B';
      winnerEl.className = 'p-6 rounded-lg border-2 border-gray-200 bg-gray-50';
      document.getElementById('winner-badge')!.textContent = `ðŸ“Š Subject Line ${label} Analysis`;
      document.getElementById('winner-explanation')!.textContent = 'Scoring factors:';
      document.getElementById('factors')!.innerHTML = result.factors.map(f =>
        `<div class="flex items-center gap-2 text-sm">
          <span class="${f.positive ? 'text-green-600' : 'text-red-500'}">${f.positive ? 'âœ“' : 'âœ—'}</span>
          <span class="text-gray-700">${f.label}</span>
          <span class="ml-auto font-mono text-xs ${f.positive ? 'text-green-600' : 'text-red-500'}">${f.impact}</span>
        </div>`
      ).join('');
    }
  });
</script>
